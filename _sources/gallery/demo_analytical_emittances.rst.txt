
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "gallery/demo_analytical_emittances.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_gallery_demo_analytical_emittances.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_gallery_demo_analytical_emittances.py:


.. _demo-analytical:

===============================================
Analytical Growth Rates and Emittance Evolution
===============================================

This example shows how to use the `~.xibs.analytical.NagaitsevIBS` class
to calculate IBS growth rates and emittances evolutions analytically.

We will demonstrate using an `xtrack.Line` of the ``CLIC`` damping ring,
for a positron beam.

.. GENERATED FROM PYTHON SOURCE LINES 15-42

.. code-block:: default

    import warnings

    from dataclasses import dataclass

    import matplotlib.pyplot as plt
    import numpy as np
    import xpart as xp
    import xtrack as xt

    from xibs.analytical import NagaitsevIBS
    from xibs.formulary import bunch_length
    from xibs.inputs import BeamParameters, OpticsParameters

    warnings.filterwarnings("ignore")  # scipy integration routines might warn for subdivisions
    plt.rcParams.update(
        {
            "font.family": "serif",
            "font.size": 20,
            "axes.titlesize": 20,
            "axes.labelsize": 20,
            "xtick.labelsize": 20,
            "ytick.labelsize": 20,
            "legend.fontsize": 15,
            "figure.titlesize": 20,
        }
    )








.. GENERATED FROM PYTHON SOURCE LINES 44-46

Let's start by defining the line and particle information, as well as some
parameters for later use:

.. GENERATED FROM PYTHON SOURCE LINES 46-57

.. code-block:: default


    line_file = "lines/chrom-corr_DR.newlattice_2GHz.json"
    harmonic_number = 2852
    rf_voltage = 4.5  # in MV
    energy_loss = 0  # let's pretend
    bunch_intensity = 4.4e9
    sigma_z = 1.58e-3
    nemitt_x = 5.6644e-07
    nemitt_y = 3.7033e-09
    n_part = int(5e3)








.. GENERATED FROM PYTHON SOURCE LINES 58-62

Setting up line and particles
-----------------------------
Let's start by loading the `xtrack.Line`, activating RF cavities and 
generating a matched Gaussian bunch:

.. GENERATED FROM PYTHON SOURCE LINES 62-85

.. code-block:: default


    line = xt.Line.from_json(line_file)
    line.build_tracker(extra_headers=["#define XTRACK_MULTIPOLE_NO_SYNRAD"])

    # ----- Power accelerating cavities ----- #
    cavities = [element for element in line.elements if isinstance(element, xt.Cavity)]
    for cavity in cavities:
        cavity.lag = 180

    p0 = xp.Particles(mass0=xp.ELECTRON_MASS_EV, q0=1, p0c=2.86e9)
    line.particle_ref = p0
    twiss = line.twiss()

    particles = xp.generate_matched_gaussian_bunch(
        num_particles=n_part,
        total_intensity_particles=bunch_intensity,
        nemitt_x=nemitt_x,
        nemitt_y=nemitt_y,
        sigma_z=sigma_z,
        particle_ref=p0,
        line=line,
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Loading line from dict:  0%      Loading line from dict:  0%      Loading line from dict:  0%      Loading line from dict:  0%      Loading line from dict:  1%      Loading line from dict:  1%      Loading line from dict:  1%      Loading line from dict:  1%      Loading line from dict:  1%      Loading line from dict:  1%      Loading line from dict:  1%      Loading line from dict:  2%      Loading line from dict:  2%      Loading line from dict:  2%      Loading line from dict:  2%      Loading line from dict:  2%      Loading line from dict:  2%      Loading line from dict:  2%      Loading line from dict:  3%      Loading line from dict:  3%      Loading line from dict:  3%      Loading line from dict:  3%      Loading line from dict:  3%      Loading line from dict:  3%      Loading line from dict:  3%      Loading line from dict:  3%      Loading line from dict:  4%      Loading line from dict:  4%      Loading line from dict:  4%      Loading line from dict:  4%      Loading line from dict:  4%      Loading line from dict:  4%      Loading line from dict:  4%      Loading line from dict:  5%      Loading line from dict:  5%      Loading line from dict:  5%      Loading line from dict:  5%      Loading line from dict:  5%      Loading line from dict:  5%      Loading line from dict:  5%      Loading line from dict:  6%      Loading line from dict:  6%      Loading line from dict:  6%      Loading line from dict:  6%      Loading line from dict:  6%      Loading line from dict:  6%      Loading line from dict:  6%      Loading line from dict:  7%      Loading line from dict:  7%      Loading line from dict:  7%      Loading line from dict:  7%      Loading line from dict:  7%      Loading line from dict:  7%      Loading line from dict:  7%      Loading line from dict:  8%      Loading line from dict:  8%      Loading line from dict:  8%      Loading line from dict:  8%      Loading line from dict:  8%      Loading line from dict:  8%      Loading line from dict:  8%      Loading line from dict:  8%      Loading line from dict:  9%      Loading line from dict:  9%      Loading line from dict:  9%      Loading line from dict:  9%      Loading line from dict:  9%      Loading line from dict:  9%      Loading line from dict:  9%      Loading line from dict: 10%      Loading line from dict: 10%      Loading line from dict: 10%      Loading line from dict: 10%      Loading line from dict: 10%      Loading line from dict: 10%      Loading line from dict: 10%      Loading line from dict: 11%      Loading line from dict: 11%      Loading line from dict: 11%      Loading line from dict: 11%      Loading line from dict: 11%      Loading line from dict: 11%      Loading line from dict: 11%      Loading line from dict: 12%      Loading line from dict: 12%      Loading line from dict: 12%      Loading line from dict: 12%      Loading line from dict: 12%      Loading line from dict: 12%      Loading line from dict: 12%      Loading line from dict: 13%      Loading line from dict: 13%      Loading line from dict: 13%      Loading line from dict: 13%      Loading line from dict: 13%      Loading line from dict: 13%      Loading line from dict: 13%      Loading line from dict: 14%      Loading line from dict: 14%      Loading line from dict: 14%      Loading line from dict: 14%      Loading line from dict: 14%      Loading line from dict: 14%      Loading line from dict: 14%      Loading line from dict: 14%      Loading line from dict: 15%      Loading line from dict: 15%      Loading line from dict: 15%      Loading line from dict: 15%      Loading line from dict: 15%      Loading line from dict: 15%      Loading line from dict: 15%      Loading line from dict: 16%      Loading line from dict: 16%      Loading line from dict: 16%      Loading line from dict: 16%      Loading line from dict: 16%      Loading line from dict: 16%      Loading line from dict: 16%      Loading line from dict: 17%      Loading line from dict: 17%      Loading line from dict: 17%      Loading line from dict: 17%      Loading line from dict: 17%      Loading line from dict: 17%      Loading line from dict: 17%      Loading line from dict: 18%      Loading line from dict: 18%      Loading line from dict: 18%      Loading line from dict: 18%      Loading line from dict: 18%      Loading line from dict: 18%      Loading line from dict: 18%      Loading line from dict: 19%      Loading line from dict: 19%      Loading line from dict: 19%      Loading line from dict: 19%      Loading line from dict: 19%      Loading line from dict: 19%      Loading line from dict: 19%      Loading line from dict: 19%      Loading line from dict: 20%      Loading line from dict: 20%      Loading line from dict: 20%      Loading line from dict: 20%      Loading line from dict: 20%      Loading line from dict: 20%      Loading line from dict: 20%      Loading line from dict: 21%      Loading line from dict: 21%      Loading line from dict: 21%      Loading line from dict: 21%      Loading line from dict: 21%      Loading line from dict: 21%      Loading line from dict: 21%      Loading line from dict: 22%      Loading line from dict: 22%      Loading line from dict: 22%      Loading line from dict: 22%      Loading line from dict: 22%      Loading line from dict: 22%      Loading line from dict: 22%      Loading line from dict: 23%      Loading line from dict: 23%      Loading line from dict: 23%      Loading line from dict: 23%      Loading line from dict: 23%      Loading line from dict: 23%      Loading line from dict: 23%      Loading line from dict: 24%      Loading line from dict: 24%      Loading line from dict: 24%      Loading line from dict: 24%      Loading line from dict: 24%      Loading line from dict: 24%      Loading line from dict: 24%      Loading line from dict: 25%      Loading line from dict: 25%      Loading line from dict: 25%      Loading line from dict: 25%      Loading line from dict: 25%      Loading line from dict: 25%      Loading line from dict: 25%      Loading line from dict: 25%      Loading line from dict: 26%      Loading line from dict: 26%      Loading line from dict: 26%      Loading line from dict: 26%      Loading line from dict: 26%      Loading line from dict: 26%      Loading line from dict: 26%      Loading line from dict: 27%      Loading line from dict: 27%      Loading line from dict: 27%      Loading line from dict: 27%      Loading line from dict: 27%      Loading line from dict: 27%      Loading line from dict: 27%      Loading line from dict: 28%      Loading line from dict: 28%      Loading line from dict: 28%      Loading line from dict: 28%      Loading line from dict: 28%      Loading line from dict: 28%      Loading line from dict: 28%      Loading line from dict: 29%      Loading line from dict: 29%      Loading line from dict: 29%      Loading line from dict: 29%      Loading line from dict: 29%      Loading line from dict: 29%      Loading line from dict: 29%      Loading line from dict: 30%      Loading line from dict: 30%      Loading line from dict: 30%      Loading line from dict: 30%      Loading line from dict: 30%      Loading line from dict: 30%      Loading line from dict: 30%      Loading line from dict: 31%      Loading line from dict: 31%      Loading line from dict: 31%      Loading line from dict: 31%      Loading line from dict: 31%      Loading line from dict: 31%      Loading line from dict: 31%      Loading line from dict: 31%      Loading line from dict: 32%      Loading line from dict: 32%      Loading line from dict: 32%      Loading line from dict: 32%      Loading line from dict: 32%      Loading line from dict: 32%      Loading line from dict: 32%      Loading line from dict: 33%      Loading line from dict: 33%      Loading line from dict: 33%      Loading line from dict: 33%      Loading line from dict: 33%      Loading line from dict: 33%      Loading line from dict: 33%      Loading line from dict: 34%      Loading line from dict: 34%      Loading line from dict: 34%      Loading line from dict: 34%      Loading line from dict: 34%      Loading line from dict: 34%      Loading line from dict: 34%      Loading line from dict: 35%      Loading line from dict: 35%      Loading line from dict: 35%      Loading line from dict: 35%      Loading line from dict: 35%      Loading line from dict: 35%      Loading line from dict: 35%      Loading line from dict: 36%      Loading line from dict: 36%      Loading line from dict: 36%      Loading line from dict: 36%      Loading line from dict: 36%      Loading line from dict: 36%      Loading line from dict: 36%      Loading line from dict: 36%      Loading line from dict: 37%      Loading line from dict: 37%      Loading line from dict: 37%      Loading line from dict: 37%      Loading line from dict: 37%      Loading line from dict: 37%      Loading line from dict: 37%      Loading line from dict: 38%      Loading line from dict: 38%      Loading line from dict: 38%      Loading line from dict: 38%      Loading line from dict: 38%      Loading line from dict: 38%      Loading line from dict: 38%      Loading line from dict: 39%      Loading line from dict: 39%      Loading line from dict: 39%      Loading line from dict: 39%      Loading line from dict: 39%      Loading line from dict: 39%      Loading line from dict: 39%      Loading line from dict: 40%      Loading line from dict: 40%      Loading line from dict: 40%      Loading line from dict: 40%      Loading line from dict: 40%      Loading line from dict: 40%      Loading line from dict: 40%      Loading line from dict: 41%      Loading line from dict: 41%      Loading line from dict: 41%      Loading line from dict: 41%      Loading line from dict: 41%      Loading line from dict: 41%      Loading line from dict: 41%      Loading line from dict: 42%      Loading line from dict: 42%      Loading line from dict: 42%      Loading line from dict: 42%      Loading line from dict: 42%      Loading line from dict: 42%      Loading line from dict: 42%      Loading line from dict: 42%      Loading line from dict: 43%      Loading line from dict: 43%      Loading line from dict: 43%      Loading line from dict: 43%      Loading line from dict: 43%      Loading line from dict: 43%      Loading line from dict: 43%      Loading line from dict: 44%      Loading line from dict: 44%      Loading line from dict: 44%      Loading line from dict: 44%      Loading line from dict: 44%      Loading line from dict: 44%      Loading line from dict: 44%      Loading line from dict: 45%      Loading line from dict: 45%      Loading line from dict: 45%      Loading line from dict: 45%      Loading line from dict: 45%      Loading line from dict: 45%      Loading line from dict: 45%      Loading line from dict: 46%      Loading line from dict: 46%      Loading line from dict: 46%      Loading line from dict: 46%      Loading line from dict: 46%      Loading line from dict: 46%      Loading line from dict: 46%      Loading line from dict: 47%      Loading line from dict: 47%      Loading line from dict: 47%      Loading line from dict: 47%      Loading line from dict: 47%      Loading line from dict: 47%      Loading line from dict: 47%      Loading line from dict: 47%      Loading line from dict: 48%      Loading line from dict: 48%      Loading line from dict: 48%      Loading line from dict: 48%      Loading line from dict: 48%      Loading line from dict: 48%      Loading line from dict: 48%      Loading line from dict: 49%      Loading line from dict: 49%      Loading line from dict: 49%      Loading line from dict: 49%      Loading line from dict: 49%      Loading line from dict: 49%      Loading line from dict: 49%      Loading line from dict: 50%      Loading line from dict: 50%      Loading line from dict: 50%      Loading line from dict: 50%      Loading line from dict: 50%      Loading line from dict: 50%      Loading line from dict: 50%      Loading line from dict: 51%      Loading line from dict: 51%      Loading line from dict: 51%      Loading line from dict: 51%      Loading line from dict: 51%      Loading line from dict: 51%      Loading line from dict: 51%      Loading line from dict: 52%      Loading line from dict: 52%      Loading line from dict: 52%      Loading line from dict: 52%      Loading line from dict: 52%      Loading line from dict: 52%      Loading line from dict: 52%      Loading line from dict: 53%      Loading line from dict: 53%      Loading line from dict: 53%      Loading line from dict: 53%      Loading line from dict: 53%      Loading line from dict: 53%      Loading line from dict: 53%      Loading line from dict: 53%      Loading line from dict: 54%      Loading line from dict: 54%      Loading line from dict: 54%      Loading line from dict: 54%      Loading line from dict: 54%      Loading line from dict: 54%      Loading line from dict: 54%      Loading line from dict: 55%      Loading line from dict: 55%      Loading line from dict: 55%      Loading line from dict: 55%      Loading line from dict: 55%      Loading line from dict: 55%      Loading line from dict: 55%      Loading line from dict: 56%      Loading line from dict: 56%      Loading line from dict: 56%      Loading line from dict: 56%      Loading line from dict: 56%      Loading line from dict: 56%      Loading line from dict: 56%      Loading line from dict: 57%      Loading line from dict: 57%      Loading line from dict: 57%      Loading line from dict: 57%      Loading line from dict: 57%      Loading line from dict: 57%      Loading line from dict: 57%      Loading line from dict: 58%      Loading line from dict: 58%      Loading line from dict: 58%      Loading line from dict: 58%      Loading line from dict: 58%      Loading line from dict: 58%      Loading line from dict: 58%      Loading line from dict: 58%      Loading line from dict: 59%      Loading line from dict: 59%      Loading line from dict: 59%      Loading line from dict: 59%      Loading line from dict: 59%      Loading line from dict: 59%      Loading line from dict: 59%      Loading line from dict: 60%      Loading line from dict: 60%      Loading line from dict: 60%      Loading line from dict: 60%      Loading line from dict: 60%      Loading line from dict: 60%      Loading line from dict: 60%      Loading line from dict: 61%      Loading line from dict: 61%      Loading line from dict: 61%      Loading line from dict: 61%      Loading line from dict: 61%      Loading line from dict: 61%      Loading line from dict: 61%      Loading line from dict: 62%      Loading line from dict: 62%      Loading line from dict: 62%      Loading line from dict: 62%      Loading line from dict: 62%      Loading line from dict: 62%      Loading line from dict: 62%      Loading line from dict: 63%      Loading line from dict: 63%      Loading line from dict: 63%      Loading line from dict: 63%      Loading line from dict: 63%      Loading line from dict: 63%      Loading line from dict: 63%      Loading line from dict: 64%      Loading line from dict: 64%      Loading line from dict: 64%      Loading line from dict: 64%      Loading line from dict: 64%      Loading line from dict: 64%      Loading line from dict: 64%      Loading line from dict: 64%      Loading line from dict: 65%      Loading line from dict: 65%      Loading line from dict: 65%      Loading line from dict: 65%      Loading line from dict: 65%      Loading line from dict: 65%      Loading line from dict: 65%      Loading line from dict: 66%      Loading line from dict: 66%      Loading line from dict: 66%      Loading line from dict: 66%      Loading line from dict: 66%      Loading line from dict: 66%      Loading line from dict: 66%      Loading line from dict: 67%      Loading line from dict: 67%      Loading line from dict: 67%      Loading line from dict: 67%      Loading line from dict: 67%      Loading line from dict: 67%      Loading line from dict: 67%      Loading line from dict: 68%      Loading line from dict: 68%      Loading line from dict: 68%      Loading line from dict: 68%      Loading line from dict: 68%      Loading line from dict: 68%      Loading line from dict: 68%      Loading line from dict: 69%      Loading line from dict: 69%      Loading line from dict: 69%      Loading line from dict: 69%      Loading line from dict: 69%      Loading line from dict: 69%      Loading line from dict: 69%      Loading line from dict: 70%      Loading line from dict: 70%      Loading line from dict: 70%      Loading line from dict: 70%      Loading line from dict: 70%      Loading line from dict: 70%      Loading line from dict: 70%      Loading line from dict: 70%      Loading line from dict: 71%      Loading line from dict: 71%      Loading line from dict: 71%      Loading line from dict: 71%      Loading line from dict: 71%      Loading line from dict: 71%      Loading line from dict: 71%      Loading line from dict: 72%      Loading line from dict: 72%      Loading line from dict: 72%      Loading line from dict: 72%      Loading line from dict: 72%      Loading line from dict: 72%      Loading line from dict: 72%      Loading line from dict: 73%      Loading line from dict: 73%      Loading line from dict: 73%      Loading line from dict: 73%      Loading line from dict: 73%      Loading line from dict: 73%      Loading line from dict: 73%      Loading line from dict: 74%      Loading line from dict: 74%      Loading line from dict: 74%      Loading line from dict: 74%      Loading line from dict: 74%      Loading line from dict: 74%      Loading line from dict: 74%      Loading line from dict: 75%      Loading line from dict: 75%      Loading line from dict: 75%      Loading line from dict: 75%      Loading line from dict: 75%      Loading line from dict: 75%      Loading line from dict: 75%      Loading line from dict: 75%      Loading line from dict: 76%      Loading line from dict: 76%      Loading line from dict: 76%      Loading line from dict: 76%      Loading line from dict: 76%      Loading line from dict: 76%      Loading line from dict: 76%      Loading line from dict: 77%      Loading line from dict: 77%      Loading line from dict: 77%      Loading line from dict: 77%      Loading line from dict: 77%      Loading line from dict: 77%      Loading line from dict: 77%      Loading line from dict: 78%      Loading line from dict: 78%      Loading line from dict: 78%      Loading line from dict: 78%      Loading line from dict: 78%      Loading line from dict: 78%      Loading line from dict: 78%      Loading line from dict: 79%      Loading line from dict: 79%      Loading line from dict: 79%      Loading line from dict: 79%      Loading line from dict: 79%      Loading line from dict: 79%      Loading line from dict: 79%      Loading line from dict: 80%      Loading line from dict: 80%      Loading line from dict: 80%      Loading line from dict: 80%      Loading line from dict: 80%      Loading line from dict: 80%      Loading line from dict: 80%      Loading line from dict: 81%      Loading line from dict: 81%      Loading line from dict: 81%      Loading line from dict: 81%      Loading line from dict: 81%      Loading line from dict: 81%      Loading line from dict: 81%      Loading line from dict: 81%      Loading line from dict: 82%      Loading line from dict: 82%      Loading line from dict: 82%      Loading line from dict: 82%      Loading line from dict: 82%      Loading line from dict: 82%      Loading line from dict: 82%      Loading line from dict: 83%      Loading line from dict: 83%      Loading line from dict: 83%      Loading line from dict: 83%      Loading line from dict: 83%      Loading line from dict: 83%      Loading line from dict: 83%      Loading line from dict: 84%      Loading line from dict: 84%      Loading line from dict: 84%      Loading line from dict: 84%      Loading line from dict: 84%      Loading line from dict: 84%      Loading line from dict: 84%      Loading line from dict: 85%      Loading line from dict: 85%      Loading line from dict: 85%      Loading line from dict: 85%      Loading line from dict: 85%      Loading line from dict: 85%      Loading line from dict: 85%      Loading line from dict: 86%      Loading line from dict: 86%      Loading line from dict: 86%      Loading line from dict: 86%      Loading line from dict: 86%      Loading line from dict: 86%      Loading line from dict: 86%      Loading line from dict: 86%      Loading line from dict: 87%      Loading line from dict: 87%      Loading line from dict: 87%      Loading line from dict: 87%      Loading line from dict: 87%      Loading line from dict: 87%      Loading line from dict: 87%      Loading line from dict: 88%      Loading line from dict: 88%      Loading line from dict: 88%      Loading line from dict: 88%      Loading line from dict: 88%      Loading line from dict: 88%      Loading line from dict: 88%      Loading line from dict: 89%      Loading line from dict: 89%      Loading line from dict: 89%      Loading line from dict: 89%      Loading line from dict: 89%      Loading line from dict: 89%      Loading line from dict: 89%      Loading line from dict: 90%      Loading line from dict: 90%      Loading line from dict: 90%      Loading line from dict: 90%      Loading line from dict: 90%      Loading line from dict: 90%      Loading line from dict: 90%      Loading line from dict: 91%      Loading line from dict: 91%      Loading line from dict: 91%      Loading line from dict: 91%      Loading line from dict: 91%      Loading line from dict: 91%      Loading line from dict: 91%      Loading line from dict: 92%      Loading line from dict: 92%      Loading line from dict: 92%      Loading line from dict: 92%      Loading line from dict: 92%      Loading line from dict: 92%      Loading line from dict: 92%      Loading line from dict: 92%      Loading line from dict: 93%      Loading line from dict: 93%      Loading line from dict: 93%      Loading line from dict: 93%      Loading line from dict: 93%      Loading line from dict: 93%      Loading line from dict: 93%      Loading line from dict: 94%      Loading line from dict: 94%      Loading line from dict: 94%      Loading line from dict: 94%      Loading line from dict: 94%      Loading line from dict: 94%      Loading line from dict: 94%      Loading line from dict: 95%      Loading line from dict: 95%      Loading line from dict: 95%      Loading line from dict: 95%      Loading line from dict: 95%      Loading line from dict: 95%      Loading line from dict: 95%      Loading line from dict: 96%      Loading line from dict: 96%      Loading line from dict: 96%      Loading line from dict: 96%      Loading line from dict: 96%      Loading line from dict: 96%      Loading line from dict: 96%      Loading line from dict: 97%      Loading line from dict: 97%      Loading line from dict: 97%      Loading line from dict: 97%      Loading line from dict: 97%      Loading line from dict: 97%      Loading line from dict: 97%      Loading line from dict: 97%      Loading line from dict: 98%      Loading line from dict: 98%      Loading line from dict: 98%      Loading line from dict: 98%      Loading line from dict: 98%      Loading line from dict: 98%      Loading line from dict: 98%      Loading line from dict: 99%      Loading line from dict: 99%      Loading line from dict: 99%      Loading line from dict: 99%      Loading line from dict: 99%      Loading line from dict: 99%      Loading line from dict: 99%      Loading line from dict: 100%      Loading line from dict: 100%      Loading line from dict: 100%      Done loading line from dict.           
    Compiling ContextCpu kernels...
    Done compiling ContextCpu kernels.




.. GENERATED FROM PYTHON SOURCE LINES 86-88

To have a look at the generated particles (see the `xsuite user guide 
<https://xsuite.readthedocs.io/en/latest/particlesmanip.html>`_ for more)

.. GENERATED FROM PYTHON SOURCE LINES 88-105

.. code-block:: default


    fig, (axx, axy, axz) = plt.subplots(3, 1, figsize=(9, 11))

    axx.plot(1e6 * particles.x, 1e5 * particles.px, ".", ms=3)
    axy.plot(1e6 * particles.y, 1e6 * particles.py, ".", ms=3)
    axz.plot(1e3 * particles.zeta, 1e3 * particles.delta, ".", ms=3)

    axx.set_xlabel(r"$x$ [$\mu$m]")
    axx.set_ylabel(r"$p_x$ [$10^{-5}$]")
    axy.set_xlabel(r"$y$ [$\mu$m]")
    axy.set_ylabel(r"$p_y$ [$10^{-3}$]")
    axz.set_xlabel(r"$z$ [$10^{-3}$]")
    axz.set_ylabel(r"$\delta$ [$10^{-3}$]")
    fig.align_ylabels([axx, axy, axz])
    plt.tight_layout()
    plt.show()




.. image-sg:: /gallery/images/sphx_glr_demo_analytical_emittances_001.svg
   :alt: demo analytical emittances
   :srcset: /gallery/images/sphx_glr_demo_analytical_emittances_001.svg, /gallery/images/sphx_glr_demo_analytical_emittances_001_2_00x.svg 2.00x
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 106-108

We can compute initial (geometrical) emittances as well as the bunch length
from the `xpart.Particles` object:

.. GENERATED FROM PYTHON SOURCE LINES 108-118

.. code-block:: default


    sig_x = np.std(particles.x[particles.state > 0])  # horizontal stdev
    sig_y = np.std(particles.y[particles.state > 0])  # vertical stdev
    sig_delta = np.std(particles.delta[particles.state > 0])  # momentum spread

    # Compute horizontal & vertical geometric emittances as well as the bunch length, all in [m]
    geom_epsx = (sig_x**2 - (twiss["dx"][0] * sig_delta) ** 2) / twiss["betx"][0]
    geom_epsy = sig_y**2 / twiss["bety"][0]
    bunch_l = np.std(particles.zeta[particles.state > 0])








.. GENERATED FROM PYTHON SOURCE LINES 119-125

Computing Elliptic Integrals and IBS Growth Rates
-------------------------------------------------
Let us initiate the `~.xibs.analytical.NagaitsevIBS` class. It is fairly
simple and is done from both the beam parameters of the particles and the
optics parameters of the line. For each of these a specific `dataclass`
is provided in the `~.xibs.inputs` module.

.. GENERATED FROM PYTHON SOURCE LINES 125-130

.. code-block:: default


    beam_params = BeamParameters(particles)
    optics = OpticsParameters(twiss)
    IBS = NagaitsevIBS(beam_params, optics)








.. GENERATED FROM PYTHON SOURCE LINES 131-135

As a first step, all calculations in rely on the computing of Nagaitsev integrals
:cite:p:`PRAB:Nagaitsev:IBS_formulas_fast_numerical_evaluation`, which is done with
a dedicated function. These are returned, but also stored internally in the **IBS**
object and will be updated internally each time they are computed.

.. GENERATED FROM PYTHON SOURCE LINES 135-140

.. code-block:: default


    integrals = IBS.integrals(geom_epsx, geom_epsy, sig_delta)
    print(integrals)
    print(IBS.elliptic_integrals)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    NagaitsevIntegrals(Ix=8.080074863172837e+19, Iy=1.4787255633698515e+17, Iz=6.011370322868276e+23)
    NagaitsevIntegrals(Ix=8.080074863172837e+19, Iy=1.4787255633698515e+17, Iz=6.011370322868276e+23)




.. GENERATED FROM PYTHON SOURCE LINES 141-145

From these the **IBS** growth rates can be computed, which is again done by calling
a dedicated function. If the integrals mentioned above have not been computed yet,
an error will be raised for the user. Once again, these are returned but also stored
internally and updated internally each time they are computed.

.. GENERATED FROM PYTHON SOURCE LINES 145-150

.. code-block:: default


    growth_rates = IBS.growth_rates(geom_epsx, geom_epsy, sig_delta, bunch_l)
    print(growth_rates)
    print(IBS.ibs_growth_rates)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    IBSGrowthRates(Tx=374.5903267281716, Ty=102.82869426832902, Tz=91.799132227187)
    IBSGrowthRates(Tx=374.5903267281716, Ty=102.82869426832902, Tz=91.799132227187)




.. GENERATED FROM PYTHON SOURCE LINES 151-156

Computing New Emittances from Growth Rates
------------------------------------------
From these one can compute the emittances at the next time step. For the emittances
at the next turn, once should use :math:`1 / f_{rev}` as the time step, which
is the default value used if it is not provided.

.. GENERATED FROM PYTHON SOURCE LINES 156-164

.. code-block:: default


    new_geom_epsx, new_geom_epsy, new_sig_delta = IBS.emittance_evolution(
        geom_epsx, geom_epsy, sig_delta
    )
    print(f"Next time step Epsilon_x = {new_geom_epsx}")
    print(f"Next time step Epsilon_y = {new_geom_epsy}")
    print(f"Next time step Sigma_delta = {new_sig_delta}")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Next time step Epsilon_x = 9.914930270784692e-11
    Next time step Epsilon_y = 6.607479068229443e-13
    Next time step Sigma_delta = 0.0017345838815304852




.. GENERATED FROM PYTHON SOURCE LINES 165-172

Analytical Evolution for Many Turns
-----------------------------------
One can then analytically look at the evolution through many turns by looping
over this calculation. Let's do this for 1000 turns. We will also re-compute
the Nagaitsev elliptic integrals and the IBS grwoth rates every 50 turns.
The more frequent this update the more accurate the results will be, but the
slower the simulation as it is the most compute-intensive process.

.. GENERATED FROM PYTHON SOURCE LINES 172-247

.. code-block:: default


    nturns = 1000  # number of turns to loop for
    ibs_step = 50  # frequency at which to re-compute the growth rates in [turns]

    # Set up a dataclass to store the results
    @dataclass
    class Records:
        """Dataclass to store (and update) important values through tracking."""

        epsilon_x: np.ndarray
        epsilon_y: np.ndarray
        sig_delta: np.ndarray
        bunch_length: np.ndarray


    # Initialize the dataclass
    turn_by_turn = Records(
        epsilon_x=np.zeros(nturns, dtype=float),
        epsilon_y=np.zeros(nturns, dtype=float),
        sig_delta=np.zeros(nturns, dtype=float),
        bunch_length=np.zeros(nturns, dtype=float),
    )

    # Store the initial values
    turn_by_turn.bunch_length[0] = np.std(particles.zeta[particles.state > 0])
    turn_by_turn.sig_delta[0] = sig_delta
    turn_by_turn.epsilon_x[0] = (sig_x**2 - (twiss["dx"][0] * sig_delta) ** 2) / twiss["betx"][0]
    turn_by_turn.epsilon_y[0] = sig_y**2 / twiss["bety"][0]

    # We loop here now
    for turn in range(1, nturns):
        # ----- Potentially re-compute the Nagaitsev integrals and growth rates ----- #
        if (turn % ibs_step == 0) or (turn == 1):
            print(f"Turn {turn}: re-computing the Nagaitsev integrals and growth rates")
            # We compute from values at the previous turn
            IBS.integrals(
                turn_by_turn.epsilon_x[turn - 1],
                turn_by_turn.epsilon_y[turn - 1],
                turn_by_turn.sig_delta[turn - 1],
            )
            IBS.growth_rates(
                turn_by_turn.epsilon_x[turn - 1],
                turn_by_turn.epsilon_y[turn - 1],
                turn_by_turn.sig_delta[turn - 1],
                turn_by_turn.bunch_length[turn - 1],
            )

        # ----- Compute the new emittances ----- #
        new_emit_x, new_emit_y, new_sig_delta = IBS.emittance_evolution(
            geom_epsx=turn_by_turn.epsilon_x[turn - 1],
            geom_epsy=turn_by_turn.epsilon_y[turn - 1],
            sigma_delta=turn_by_turn.sig_delta[turn - 1],
            # dt = 1.0 / IBS.optics.revolution_frequency,  # default value
        )

        # compute bunch length analytically as the Particles object hasn't changed
        sigma_e = new_sig_delta * IBS.beam_parameters.beta_rel**2
        bunch_l = bunch_length(
            optics.circumference,
            harmonic_number,
            beam_params.total_energy_GeV,
            optics.slip_factor,
            sigma_e,
            beam_params.beta_rel,
            rf_voltage * 1e-3,  # has to be provided in [MV]
            energy_loss,  # in [GeV] but 0 is 0 in all units
            beam_params.particle_charge,
        )

        # ----- Update the records with the new values ----- #
        turn_by_turn.bunch_length[turn] = bunch_l
        turn_by_turn.sig_delta[turn] = new_sig_delta
        turn_by_turn.epsilon_x[turn] = new_emit_x
        turn_by_turn.epsilon_y[turn] = new_emit_y





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Turn 1: re-computing the Nagaitsev integrals and growth rates
    Turn 50: re-computing the Nagaitsev integrals and growth rates
    Turn 100: re-computing the Nagaitsev integrals and growth rates
    Turn 150: re-computing the Nagaitsev integrals and growth rates
    Turn 200: re-computing the Nagaitsev integrals and growth rates
    Turn 250: re-computing the Nagaitsev integrals and growth rates
    Turn 300: re-computing the Nagaitsev integrals and growth rates
    Turn 350: re-computing the Nagaitsev integrals and growth rates
    Turn 400: re-computing the Nagaitsev integrals and growth rates
    Turn 450: re-computing the Nagaitsev integrals and growth rates
    Turn 500: re-computing the Nagaitsev integrals and growth rates
    Turn 550: re-computing the Nagaitsev integrals and growth rates
    Turn 600: re-computing the Nagaitsev integrals and growth rates
    Turn 650: re-computing the Nagaitsev integrals and growth rates
    Turn 700: re-computing the Nagaitsev integrals and growth rates
    Turn 750: re-computing the Nagaitsev integrals and growth rates
    Turn 800: re-computing the Nagaitsev integrals and growth rates
    Turn 850: re-computing the Nagaitsev integrals and growth rates
    Turn 900: re-computing the Nagaitsev integrals and growth rates
    Turn 950: re-computing the Nagaitsev integrals and growth rates




.. GENERATED FROM PYTHON SOURCE LINES 248-251

Feel free to run this simulation for more turns, or with a different frequency
of the IBS growth rates re-computation. After this is done running, we can plot
the evolutions across the turns:

.. GENERATED FROM PYTHON SOURCE LINES 251-266

.. code-block:: default


    figure, (epsx, epsy, sigdelta) = plt.subplots(3, 1, sharex=True, figsize=(10, 11))

    epsx.plot(1e10 * turn_by_turn.epsilon_x)
    epsy.plot(1e13 * turn_by_turn.epsilon_y)
    sigdelta.plot(1e3 * turn_by_turn.sig_delta)

    epsx.set_ylabel(r"$\varepsilon_x$ [$10^{-10}$m]")
    epsy.set_ylabel(r"$\varepsilon_y$ [$10^{-13}$m]")
    sigdelta.set_ylabel(r"$\sigma_{\delta}$ [$10^{-3}$]")
    sigdelta.set_xlabel("Turn Number")
    figure.align_ylabels([epsx, epsy, sigdelta])
    plt.tight_layout()
    plt.show()




.. image-sg:: /gallery/images/sphx_glr_demo_analytical_emittances_002.svg
   :alt: demo analytical emittances
   :srcset: /gallery/images/sphx_glr_demo_analytical_emittances_002.svg, /gallery/images/sphx_glr_demo_analytical_emittances_002_2_00x.svg 2.00x
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 267-274

.. admonition:: References

   The use of the following functions, methods, classes and modules is shown
   in this example:

   - `~xibs.analytical`: `~.xibs.analytical.NagaitsevIBS`
   - `~xibs.inputs`: `~xibs.inputs.BeamParameters`, `~xibs.inputs.OpticsParameters`


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 32.340 seconds)


.. _sphx_glr_download_gallery_demo_analytical_emittances.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: demo_analytical_emittances.py <demo_analytical_emittances.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: demo_analytical_emittances.ipynb <demo_analytical_emittances.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
